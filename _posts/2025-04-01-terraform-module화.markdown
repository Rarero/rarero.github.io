---
layout: post
title: terraform moduleν™”
image: terraform.png
date: 2025-04-01 09:00:00 +0900
tags: [terraform, architecture]
categories: terraform
---
Terraform λ¨λ“ν™”λ” μΈν”„λΌμ¤νΈλ­μ² μ½”λ“λ¥Ό λ” μ²΄κ³„μ μ΄κ³  μ¬μ‚¬μ© κ°€λ¥ν•κ² λ§λ“¤κΈ° μ„ν• μ„¤κ³„ ν¨ν„΄μ…λ‹λ‹¤. μ΄λ” λ°λ³µμ μΈ μ½”λ“λ¥Ό μ¤„μ΄κ³ , μ μ§€λ³΄μμ„±μ„ λ†’μ΄λ©°, μΌκ΄€λ μΈν”„λΌλ¥Ό κµ¬μ„±ν•  μ μλ„λ΅ λ•μµλ‹λ‹¤.

---

### 1. Terraform λ¨λ“ν™”λ€?

λ¨λ“(Module)μ€ κ΄€λ ¨λ Terraform λ¦¬μ†μ¤λ“¤μ μ§‘ν•©μΌλ΅, ν•λ‚μ λ…Όλ¦¬ λ‹¨μ„λ΅ λ¬¶μ—¬ λ³„λ„λ΅ κ΄€λ¦¬λκ³  μ¬μ‚¬μ©λ  μ μμµλ‹λ‹¤. λ§μΉ ν”„λ΅κ·Έλλ° μ–Έμ–΄μ ν•¨μμ²λΌ λ™μ‘ν•μ—¬, μ…λ ¥κ°’(variables)μ„ λ°›μ•„ μ¶λ ¥κ°’(outputs)μ„ μ κ³µν•©λ‹λ‹¤.

---

### 2. μ™ Terraform λ¨λ“ν™”κ°€ ν•„μ”ν•κ°€?

**2.1 μ¬μ‚¬μ©μ„±**: λ™μΌν• μΈν”„λΌ κµ¬μ„±μ„ μ—¬λ¬ ν™κ²½(dev, stage, prod)μ—μ„ μ¬μ‚¬μ© κ°€λ¥  
**2.2 μ μ§€λ³΄μμ„±**: ν•λ‚μ λ¨λ“λ§ μμ •ν•λ©΄ μ΄λ¥Ό μ‚¬μ©ν•λ” λ¨λ“  κ³³μ— λ³€κ²½μ‚¬ν•­ λ°μ  
**2.3 κµ¬μ΅°ν™”**: μ½”λ“λ² μ΄μ¤λ¥Ό κΈ°λ¥λ³„λ΅ λ¶„λ¦¬ν•μ—¬ κ°€λ…μ„±κ³Ό κ΄€λ¦¬μ„± ν–¥μƒ  
**2.4 ν‘μ—… ν¨μ¨μ„±**: ν€ λ‹¨μ„λ΅ μ—­ν• μ„ λ‚λ„μ–΄ κ°λ° κ°€λ¥

---

### 3. κµ¬μ„± λ°©λ²•

1. **λ£¨νΈ λ¨λ“(Root Module)**: Terraform λ…λ Ήμ–΄λ¥Ό μ‹¤ν–‰ν•λ” μµμƒμ„ λ””λ ‰ν† λ¦¬
2. **μ„λΈ λ¨λ“(Submodule)**: λ³„λ„μ λ””λ ‰ν† λ¦¬μ—μ„ μ •μλ λ¨λ“λ΅, `module` λΈ”λ΅μ„ ν†µν•΄ νΈμ¶

**μμ‹: κΈ°λ³Έ λ¨λ“ λ””λ ‰ν† λ¦¬ κµ¬μ΅°**
```
.
β”β”€β”€ main.tf
β””β”€β”€ modules/
    β””β”€β”€ vnet/
        β”β”€β”€ main.tf
        β”β”€β”€ variables.tf
        β””β”€β”€ outputs.tf
```
<br>

**μμ‹: λ¨λ“ νΈμ¶ λ°©μ‹**
```hcl
module "vnet" {
  source = "./modules/vnet"
  name   = "example-vnet"
  cidr   = "10.0.0.0/16"
}
```

---

### 4. ν™κ²½λ³„(dev, stage, prod) κµ¬μ„± μμ‹

Terraform λ¨λ“μ€ ν™κ²½λ³„λ΅ λ””λ ‰ν† λ¦¬λ¥Ό λ‚λ„μ–΄ κ° ν™κ²½μ—μ„ λ™μΌν• λ¨λ“μ„ λ‹¤λ¥΄κ² κµ¬μ„±ν•  μ μμµλ‹λ‹¤. μ΄ λ°©μ‹μ€ ν™κ²½ κ°„ μ„¤μ • μ°¨μ΄λ” μ μ§€ν•λ©΄μ„λ„ μΌκ΄€λ λ¦¬μ†μ¤λ¥Ό μ‰½κ² λ°°ν¬ν•  μ μκ² ν•©λ‹λ‹¤.

**μμ‹: ν™κ²½λ³„ λ””λ ‰ν† λ¦¬ κµ¬μ΅°**
```
.
β”β”€β”€ envs/
β”‚   β”β”€β”€ dev/
β”‚   β”‚   β”β”€β”€ main.tf
β”‚   β”‚   β””β”€β”€ terraform.tfvars
β”‚   β”β”€β”€ stage/
β”‚   β”‚   β”β”€β”€ main.tf
β”‚   β”‚   β””β”€β”€ terraform.tfvars
β”‚   β””β”€β”€ prod/
β”‚       β”β”€β”€ main.tf
β”‚       β””β”€β”€ terraform.tfvars
β””β”€β”€ modules/
    β””β”€β”€ vnet/
        β”β”€β”€ main.tf
        β”β”€β”€ variables.tf
        β””β”€β”€ outputs.tf
```

**μμ‹: modules/vnet/variables.tf λ³€μ μ •μ**
```
variable "name" {
  description = "Virtual Network name"
  type        = string
}

variable "cidr" {
  description = "CIDR block for the Virtual Network"
  type        = string
}
```

**μμ‹: ν™κ²½λ³„ main.tf κµ¬μ„±**
ν™κ²½λ³„ main.tf λ‚΄μ© μμ‹ (`envs/dev/main.tf`):
```hcl
module "vnet" {
  source = "../../modules/vnet"
  name   = var.name
  cidr   = var.cidr
}
```

**μμ‹: ν™κ²½λ³„ tfvars νμΌ**
ν™κ²½λ³„ λ³€μ νμΌ (`envs/dev/terraform.tfvars`):
```hcl
name = "dev-vnet"
cidr = "10.0.0.0/16"
```

μ΄λ° κµ¬μ΅°λ¥Ό μ‚¬μ©ν•λ©΄ ν™κ²½λ³„λ΅ λ¨λ“μ„ λ…λ¦½μ μΌλ΅ κ΄€λ¦¬ν•λ©΄μ„λ„, κ³µν†µλ κµ¬μ΅°μ™€ λ΅μ§μ€ μ μ§€ν•  μ μμ–΄ μ½”λ“μ μΌκ΄€μ„±κ³Ό μ μ§€λ³΄μμ„±μ„ λ†’μΌ μ μμµλ‹λ‹¤.

---

### 5. tfvars νμΌμ΄λ€?

`terraform.tfvars` νμΌμ€ Terraformμ—μ„ λ³€μ κ°’μ„ μ •μν•λ” νμΌλ΅, `variables.tf` νμΌμ— μ„ μ–Έλ λ³€μλ“¤μ— μ‹¤μ  κ°’μ„ ν• λ‹Ήν•λ” λ° μ‚¬μ©λ©λ‹λ‹¤. μ΄λ¥Ό ν†µν•΄ μ½”λ“μ™€ μ„¤μ • κ°’μ„ λ¶„λ¦¬ν•μ—¬ ν™κ²½μ— λ”°λΌ μ μ—°ν•κ² κµ¬μ„±μ„ λ³€κ²½ν•  μ μμµλ‹λ‹¤.

μμ‹:
**variables.tf**
```hcl
variable "name" {}
variable "cidr" {}
```

**terraform.tfvars**
```hcl
name = "dev-vnet"
cidr = "10.0.0.0/16"
```

**main.tf**
```hcl
module "vnet" {
  source = "../../modules/vnet"
  name   = var.name
  cidr   = var.cidr
}
```

### 5.1 tfvars νμΌμ μ¥μ 

- **ν™κ²½λ³„ κµ¬μ„± λ¶„λ¦¬**: dev, stage, prod λ“± ν™κ²½μ— λ”°λΌ μ„λ΅ λ‹¤λ¥Έ κ°’μ„ μ μ©ν•  μ μμ
- **μλ™ λ΅λ“**: `terraform.tfvars` λλ” `*.auto.tfvars` νμΌμ€ λ…μ‹μ  μ§€μ • μ—†μ΄ μλ™μΌλ΅ λ΅λ“λ¨
- **λ…ν™•ν• μ„¤μ • κ΄€λ¦¬**: μ½”λ“μ™€ μ„¤μ • κ°’μ΄ λ¶„λ¦¬λμ–΄ κ°€λ…μ„±κ³Ό κ΄€λ¦¬μ„±μ΄ λ†’μ•„μ§

### 5.2 μ—¬λ¬ ν™κ²½ κµ¬μ„± μ‹ ν™μ©

νμΌ μ΄λ¦„μ„ ν™κ²½λ³„λ΅ λ‚λ„μ–΄ μ‚¬μ©ν•λ” κ²ƒλ„ μΌλ°μ μ…λ‹λ‹¤:
- `dev.tfvars`
- `stage.tfvars`
- `prod.tfvars`

μ΄ κ²½μ° Terraform λ…λ Ή μ‹¤ν–‰ μ‹ λ…μ‹μ μΌλ΅ νμΌμ„ μ§€μ •ν•΄μ•Ό ν•©λ‹λ‹¤:
```bash
terraform apply -var-file="dev.tfvars"
```

μ΄μ²λΌ tfvars νμΌμ„ ν™μ©ν•λ©΄ λ¨λ“μ€ κ·Έλ€λ΅ μ μ§€ν•λ©΄μ„λ„ κ° ν™κ²½μ— λ§λ” μ„¤μ •μ„ μ‰½κ² μ£Όμ…ν•  μ μμ–΄ μΈν”„λΌ κ΄€λ¦¬κ°€ ν¨μ¨μ μ΄κ³  μΌκ΄€μ„± μκ² λ©λ‹λ‹¤.

ν•„μ”μ— λ”°λΌ location, tags, subnet λ©λ΅ λ“±μ κ°’μ„ μ¶”κ°€ λ³€μλ΅ λ°›μ•„ λ¨λ“μ„ λ”μ± ν™•μ¥ν•  μ μμµλ‹λ‹¤.

μ:
```hcl
variable "location" {
  description = "Azure region"
  type        = string
  default     = "koreacentral"
}

variable "tags" {
  description = "Resource tags"
  type        = map(string)
  default     = {}
}
```
> π’΅ **TIP**: ν™κ²½μ— λ”°λΌ `.auto.tfvars` νμΌμ„ λ§λ“¤μ–΄λ‘λ©΄ Terraformμ΄ μλ™μΌλ΅ λ¶λ¬μµλ‹λ‹¤!

---

### 6. λ§λ¬΄λ¦¬

**Terraform λ¨λ“ν™”λ” μΈν”„λΌ μλ™ν™”μ ν™•μ¥μ„±κ³Ό ν¨μ¨μ„±μ„ λ†’μ΄λ” ν•µμ‹¬μ μΈ κΈ°λ²•μ…λ‹λ‹¤.** μ΄λ¥Ό ν†µν•΄ μ•μ •μ μ΄κ³  μΌκ΄€λ μΈν”„λΌ μ΄μμ΄ κ°€λ¥ν•΄μ§‘λ‹λ‹¤.